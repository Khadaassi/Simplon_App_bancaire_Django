{% extends "base.html" %}
{% block content %}
    <h2>Chat Room</h2>
    <ul id="chat-log">
        {% for message in messages %}
            <li><strong>{{ message.sender.username|default:"Anonyme" }}</strong>: {{ message.content }}</li>
        {% endfor %}
    </ul>

    <input id="message-input" type="text" placeholder="Écrire un message..." autocomplete="off">
    <button id="send-button">Envoyer</button>

    <script>
        // Création du WebSocket
        const chatSocket = new WebSocket("ws://" + window.location.host + "/ws/chat/");

        // Écoute des nouveaux messages
        chatSocket.onmessage = function(event) {
            const data = JSON.parse(event.data);

            // Crée un nouvel élément pour afficher le message
            const chatLog = document.getElementById("chat-log");
            const newMessage = document.createElement("li");
            newMessage.innerHTML = `<strong>${data.username}</strong>: ${data.message}`;

            // Ajoute le message en bas de la liste
            chatLog.appendChild(newMessage);
        };

        chatSocket.onclose = function(event) {
            console.error("Le WebSocket s’est fermé de manière inattendue.");
        };

        // Fonction pour envoyer un message
        function sendMessage() {
            const messageInput = document.getElementById("message-input");
            const message = messageInput.value.trim();
            const username = "{{ request.user.username }}";  // Récupère le nom de l'utilisateur

            if (message !== "") {
                chatSocket.send(JSON.stringify({
                    "message": message,
                    "username": username
                }));
                messageInput.value = "";  // Efface le champ de saisie
            }
        }

        // Envoi du message au clic du bouton
        document.getElementById("send-button").onclick = sendMessage;

        // Envoi du message avec "Enter"
        document.getElementById("message-input").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        });
    </script> 
    
{% endblock %}
